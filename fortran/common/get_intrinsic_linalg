#!/usr/bin/env bash
# This script generates a modified version of linalg.f90 that uses the intrinsic `matmul` function
# for `matprod` (matrix multiplication).
# Usage: ./get_intrinsic_linalg

LINALG_ORIG="linalg.f90"
LINALG_NEW="intrinsic_linalg.f90"

cat >"$LINALG_NEW" << EOF
!--------------------------------------------------------------------------------------------------!
! This is a modified version of $LINALG_ORIG that uses the intrinsic MATMUL function for MATPROD.
! We define MATPROD as an alias for MATMUL, and comment out our implementation of MATPROD.
! For other information, please refer to $LINALG_ORIG.
! Generated by $(basename "$0").
!--------------------------------------------------------------------------------------------------!

!--------------------------------------------------------------------------------------------------!
! This is a module that provides the intrinsic MATMUL function.
module matmul_mod
implicit none
private
public :: matmul
intrinsic :: matmul
end module matmul_mod
!--------------------------------------------------------------------------------------------------!


EOF

cat "$LINALG_ORIG" >> "$LINALG_NEW"

# Replace the line `module linalg` with `module linalg\nuse matmul_mod, only : matprod => matmul`,
# so that we can use the intrinsic `matmul` function as `matprod`.
sed -i 's|\(^\s*\)\(module linalg_mod\)|\1\2\n\n\1!Define MATPROD as an alias for MATMUL.\n\1use matmul_mod, only : matprod => matmul\n|' "$LINALG_NEW"

# Comment out the lines between `interface matprod` and `end interface matprod` in  "$LINALG_NEW".
sed -i '/interface matprod/,/end interface matprod/s/^/!/' "$LINALG_NEW"

# Comment out the lines between `function matprodxy` and `end function matprodxy` in
# "$LINALG_NEW", where xy is one of 12, 21, and 22
for xy in 12 21 22; do
    sed -i "/function matprod${xy}/,/end function matprod${xy}/s/^/!/" "$LINALG_NEW"
done
