#!/usr/bin/env bash
# This script generates a modified version of linalg.f90 that uses the intrinsic `matmul` function
# for `matprod` (matrix multiplication) and `dot_product` for `inprod` (inner product).
# Usage: ./get_intrinsic_linalg

THIS_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LINALG_ORIG="$THIS_DIR"/linalg.f90
LINALG_NEW="$THIS_DIR"/intrinsic_linalg.f90

cat >"$LINALG_NEW" << EOF
!--------------------------------------------------------------------------------------------------!
! This is a modified version of $LINALG_ORIG that uses the intrinsic MATMUL for MATPROD and
! DOT_PRODUCT for INPROD.
!
! We define MATPROD as an alias for MATMUL, and comment out our implementation of MATPROD.
! The similar is done for INPROD.
!
! For other information, please refer to $LINALG_ORIG.
!
! Generated by $(basename "$0").
!--------------------------------------------------------------------------------------------------!


module intrinsic_linalg_mod
!--------------------------------------------------------------------------------------------------!
! This module provides the intrinsic MATMUL and DOT_PRODUCT functions.
implicit none
private
public :: matmul, dot_product
intrinsic :: matmul, dot_product
end module intrinsic_linalg_mod
!--------------------------------------------------------------------------------------------------!


EOF

cat "$LINALG_ORIG" >> "$LINALG_NEW"

# Replace the line `module linalg_mod` with `module linalg\nuse intrinsic_linalg_mod ...` so that we
# can use the intrinsic `matmul` function as `matprod` and `dot_product` as `inprod`.
sed -i 's|\(^\s*\)\(module linalg_mod\)|\1\2\n\n\1! Define MATPROD as an alias for MATMUL and INPROD for DOT_PRODUCT.\n\1use, non_intrinsic :: intrinsic_linalg_mod, only : matprod => matmul, inprod => dot_product\n|' "$LINALG_NEW"

# Comment out the lines between `interface matprod` and `end interface matprod` in  "$LINALG_NEW".
sed -i '/interface matprod/,/end interface matprod/s/^/!/' "$LINALG_NEW"

# Comment out the lines between `function matprodxy` and `end function matprodxy` in
# "$LINALG_NEW", where xy is one of 12, 21, and 22
for xy in 12 21 22; do
    sed -i "/function matprod${xy}/,/end function matprod${xy}/s/^/!/" "$LINALG_NEW"
done

# Comment out the lines between `function inprod` and `end function inprod` in "$LINALG_NEW".
sed -i '/function inprod/,/end function inprod/s/^/!/' "$LINALG_NEW"
